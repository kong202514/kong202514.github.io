 

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>StickyCloud Pro - Complete Sync</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&family=Kanit:wght@400;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #f1f5f9;
            --panel: #ffffff;
            --accent: #4f46e5;
            --text: #0f172a;
            --muted: #64748b;
            --border: #e2e8f0;
        }

        body.dark {
            --bg: #0f172a;
            --panel: #1e293b;
            --accent: #818cf8;
            --text: #f8fafc;
            --muted: #94a3b8;
            --border: #334155;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: 0.3s;
        }

        header {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            z-index: 100;
            gap: 15px;
        }

        .logo {
            font-family: 'Kanit';
            font-weight: 600;
            font-size: 1.3rem;
            color: var(--accent);
        }

        .toolbar {
            margin-left: auto;
            display: flex;
            gap: 10px;
        }

        .btn {
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
        }

        .btn:hover {
            background: var(--accent);
            color: white;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            border: none;
        }

        .page-bar {
            background: var(--panel);
            display: flex;
            align-items: center;
            padding: 8px 20px;
            gap: 12px;
            border-top: 1px solid var(--border);
        }

        .tab {
            padding: 6px 18px;
            background: var(--bg);
            border: 2px solid transparent;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: 0.2s;
        }

        .tab.active {
            border-color: var(--accent);
            background: var(--panel);
            font-weight: 600;
        }

        .tab .del-page {
            opacity: 0.3;
            font-size: 12px;
        }

        .tab .del-page:hover {
            opacity: 1;
            color: #ef4444;
        }

        .board {
            flex: 1;
            position: relative;
            overflow: auto;
            background-image: radial-gradient(var(--muted) 0.5px, transparent 0.5px);
            background-size: 30px 30px;
        }

        .note {
            position: absolute;
            width: 220px;
            min-height: 120px;
            background: #fffacd;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            cursor: grab;
            display: flex;
            flex-direction: column;
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            opacity: 0.1;
            transition: 0.2s;
        }

        .note:hover .note-header {
            opacity: 1;
        }

        .content {
            flex: 1;
            outline: none;
            font-size: 14px;
            color: #334155;
            min-height: 60px;
        }

        .ring-active {
            outline: 3px solid var(--accent);
        }

        svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        footer {
            font-size: 11px;
            padding: 6px;
            text-align: center;
            color: var(--muted);
            background: var(--panel);
        }
    </style>
</head>

<body>

    <header>
        <div class="logo">StickyCloud</div>
        <div class="toolbar">
            <button class="btn btn-primary" id="addNote"><span>+</span> ‡πÇ‡∏ô‡πâ‡∏ï‡πÉ‡∏´‡∏°‡πà</button>
            <div id="syncIndicator"
                style="font-size: 12px; color: var(--muted); display: flex; align-items: center; gap: 5px;">
                <span id="syncDot" style="width: 8px; height: 8px; background: #10b981; border-radius: 50%;"></span>
                <span id="syncText">‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</span>
            </div>
            <button class="btn" id="toggleDark">üåô</button>
        </div>
    </header>

    <main id="board" class="board"></main>

    <div class="page-bar" id="pageBar">
        <button class="btn" id="addPage"
            style="border-radius: 50%; width: 32px; height: 32px; padding: 0; justify-content: center;">+</button>
    </div>

    <footer>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡πÇ‡∏ô‡πâ‡∏ï: ‡∏Ñ‡∏•‡∏¥‡∏Å üîó ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á</footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getFirestore, setDoc, doc, onSnapshot, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB3kPHRDHeYd6rjspNjCH11QG7T2bTd7PM",
        authDomain: "stickey-note-6bb95.firebaseapp.com",
        projectId: "stickey-note-6bb95",
        storageBucket: "stickey-note-6bb95.firebasestorage.app",
        messagingSenderId: "266704545369",
        appId: "1:266704545369:web:e403d47f324a91234a3348",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    class Note {
        constructor(parent, data) {
            this.parent = parent;
            this.id = data.id || "n_" + crypto.randomUUID();
            this.text = data.text || '';
            this.color = data.color || '#fffacd';
            this.x = data.x || 100;
            this.y = data.y || 100;
            this.createEl();
        }

        createEl() {
            this.el = document.createElement('div');
            this.el.className = 'note';
            this.el.style.backgroundColor = this.color;
            this.el.style.left = this.x + 'px';
            this.el.style.top = this.y + 'px';
            this.el.dataset.id = this.id;
            this.el.innerHTML = `
                <div class="note-header">
                    <button class="btn-icon connect-btn">üîó</button>
                    <div style="display:flex; gap:5px;">
                        <input type="color" class="color-picker" value="${this.color}">
                        <button class="delete-btn">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="content" contenteditable="true">${this.text}</div>
            `;
            const contentEl = this.el.querySelector('.content');
            contentEl.oninput = () => { this.text = contentEl.innerText; this.parent.autoSave(); };
            this.el.querySelector('.delete-btn').onclick = () => this.parent.deleteNote(this.id);
            this.el.querySelector('.connect-btn').onclick = () => this.parent.startConnect(this);
            this.el.querySelector('.color-picker').oninput = (e) => {
                this.color = e.target.value;
                this.el.style.backgroundColor = this.color;
                this.parent.autoSave();
            };
            this.setupDrag();
        }

        setupDrag() {
            let ox, oy, isDragging = false;
            this.el.onmousedown = (e) => {
                if (e.target.closest('button, input, .content')) return;
                isDragging = true;
                this.parent.isDraggingAny = true;
                ox = e.clientX - this.el.offsetLeft;
                oy = e.clientY - this.el.offsetTop;
                this.el.style.zIndex = 1000;
            };
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                this.x = e.clientX - ox; this.y = e.clientY - oy;
                this.el.style.left = this.x + 'px'; this.el.style.top = this.y + 'px';
                this.parent.drawConnections();
            });
            document.addEventListener('mouseup', () => {
                if (isDragging) { isDragging = false; this.parent.isDraggingAny = false; this.el.style.zIndex = ''; this.parent.autoSave(); }
            });
        }
    }

    class StickyApp {
        constructor() {
            this.notes = [];
            this.connections = [];
            this.pages = [{ id: 'default', name: '‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å' }]; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            this.activePageId = localStorage.getItem('cloud_active_page') || 'default';
            this.container = document.getElementById('board');
            this.unsubscribeNotes = null;
            this.unsubscribePages = null;
            this.saveTimeout = null;
            this.isDraggingAny = false;
            this.lastLocalUpdate = 0;

            this.init();
        }

        async init() {
            this.svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            this.svg.innerHTML = `<defs><marker id="arrow" markerWidth="10" markerHeight="10" refX="20" refY="5" orient="auto"><path d="M0,0 L10,5 L0,10 Z" fill="#94a3b8"/></marker></defs>`;
            this.container.appendChild(this.svg);

            document.getElementById('addNote').onclick = () => this.addNote();
            document.getElementById('addPage').onclick = () => this.addPage();
            document.getElementById('toggleDark').onclick = () => {
                document.body.classList.toggle('dark');
                localStorage.theme = document.body.classList.contains('dark') ? 'dark' : 'light';
            };
            if (localStorage.theme === 'dark') document.body.classList.add('dark');

            this.syncPagesList(); // ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡πá‡∏ö‡∏´‡∏ô‡πâ‡∏≤
            this.syncCurrentPageNotes(); // ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÇ‡∏ô‡πâ‡∏ï
        }

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ (Cloud Pages) ---
        syncPagesList() {
            if (this.unsubscribePages) this.unsubscribePages();
            this.unsubscribePages = onSnapshot(doc(db, "stickynotes", "_metadata"), (snap) => {
                if (snap.exists()) {
                    this.pages = snap.data().list || [{ id: 'default', name: '‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å' }];
                } else {
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á metadata ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
                    setDoc(doc(db, "stickynotes", "_metadata"), { list: this.pages });
                }
                this.renderTabs();
            });
        }

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÇ‡∏ô‡πâ‡∏ï (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ï‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á) ---
        syncCurrentPageNotes() {
            if (this.unsubscribeNotes) this.unsubscribeNotes();
            this.unsubscribeNotes = onSnapshot(doc(db, "stickynotes", this.activePageId), (snap) => {
                if (this.isDraggingAny) return;
                if (snap.exists()) {
                    const data = snap.data();
                    if (data.lastChanged <= this.lastLocalUpdate) return;
                    this.renderBoard(data);
                } else {
                    this.renderBoard({ notes: [], connections: [] });
                }
                this.updateStatus("‚úÖ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå", "#10b981");
            });
        }

        renderBoard(data) {
            const remoteNotes = data.notes || [];
            this.connections = data.connections || [];
            const remoteIds = remoteNotes.map(rn => rn.id);
            this.notes = this.notes.filter(ln => { if (!remoteIds.includes(ln.id)) { ln.el.remove(); return false; } return true; });
            remoteNotes.forEach(rn => {
                const existing = this.notes.find(ln => ln.id === rn.id);
                if (existing) {
                    if (existing.text !== rn.text && document.activeElement !== existing.el.querySelector('.content')) {
                        existing.el.querySelector('.content').innerText = rn.text; existing.text = rn.text;
                    }
                    if (existing.color !== rn.color) {
                        existing.el.style.backgroundColor = rn.color;
                        existing.el.querySelector('.color-picker').value = rn.color;
                        existing.color = rn.color;
                    }
                    existing.x = rn.x; existing.y = rn.y;
                    existing.el.style.left = rn.x + 'px'; existing.el.style.top = rn.y + 'px';
                } else {
                    const n = new Note(this, rn); this.notes.push(n); this.container.appendChild(n.el);
                }
            });
            this.drawConnections();
        }

        autoSave() {
            clearTimeout(this.saveTimeout);
            this.updateStatus("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...", "#3b82f6");
            this.saveTimeout = setTimeout(async () => {
                this.lastLocalUpdate = Date.now();
                const data = {
                    notes: this.notes.map(n => ({ id: n.id, text: n.text, color: n.color, x: n.x, y: n.y })),
                    connections: this.connections,
                    lastChanged: this.lastLocalUpdate
                };
                await setDoc(doc(db, "stickynotes", this.activePageId), data);
                this.updateStatus("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß", "#10b981");
            }, 600);
        }

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡πá‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡∏∂‡πâ‡∏ô Cloud) ---
        renderTabs() {
            const bar = document.getElementById('pageBar');
            bar.querySelectorAll('.tab').forEach(t => t.remove());
            this.pages.forEach(p => {
                const tab = document.createElement('div');
                tab.className = `tab ${p.id === this.activePageId ? 'active' : ''}`;
                tab.innerHTML = `<span>${p.name}</span> <span class="del-page">‚úï</span>`;
                tab.onclick = () => this.switchPage(p.id);
                tab.querySelector('.del-page').onclick = (e) => { e.stopPropagation(); this.deletePage(p); };
                bar.insertBefore(tab, document.getElementById('addPage'));
            });
        }

        switchPage(id) {
            if (this.activePageId === id) return;
            this.activePageId = id;
            localStorage.setItem('cloud_active_page', id);
            this.lastLocalUpdate = 0;
            this.syncCurrentPageNotes();
            this.renderTabs();
        }

        async addPage() {
            const name = prompt("‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà:");
            if (!name) return;
            const newPage = { id: "pg_" + Date.now(), name };
            await updateDoc(doc(db, "stickynotes", "_metadata"), {
                list: arrayUnion(newPage)
            });
            this.switchPage(newPage.id);
        }

        async deletePage(pageObj) {
            if (this.pages.length === 1) return;
            if (!confirm(`‡∏•‡∏ö‡∏´‡∏ô‡πâ‡∏≤ "${pageObj.name}" ‡∏ñ‡∏≤‡∏ß‡∏£?`)) return;
            await updateDoc(doc(db, "stickynotes", "_metadata"), {
                list: arrayRemove(pageObj)
            });
            if (this.activePageId === pageObj.id) this.switchPage(this.pages[0].id);
        }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
        addNote() {
            const n = new Note(this, { x: 50 + Math.random() * 100, y: 50 + Math.random() * 100 });
            this.notes.push(n); this.container.appendChild(n.el);
            this.autoSave();
        }
        deleteNote(id) {
            this.notes = this.notes.filter(n => n.id !== id);
            this.container.querySelector(`[data-id="${id}"]`)?.remove();
            this.connections = this.connections.filter(c => c.from !== id && c.to !== id);
            this.drawConnections(); this.autoSave();
        }
        startConnect(note) {
            if (!this.pendingNote) { this.pendingNote = note; note.el.classList.add('ring-active'); }
            else {
                if (this.pendingNote.id !== note.id) {
                    if (!this.connections.some(c => (c.from === this.pendingNote.id && c.to === note.id))) {
                        this.connections.push({ from: this.pendingNote.id, to: note.id });
                        this.drawConnections(); this.autoSave();
                    }
                }
                this.pendingNote.el.classList.remove('ring-active'); this.pendingNote = null;
            }
        }
        drawConnections() {
            this.svg.querySelectorAll('line').forEach(l => l.remove());
            this.connections.forEach(c => {
                const n1 = this.notes.find(n => n.id === c.from);
                const n2 = this.notes.find(n => n.id === c.to);
                if (n1 && n2) {
                    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    line.setAttribute('x1', n1.x + 110); line.setAttribute('y1', n1.y + 60);
                    line.setAttribute('x2', n2.x + 110); line.setAttribute('y2', n2.y + 60);
                    line.setAttribute('stroke', '#94a3b8'); line.setAttribute('stroke-width', '2');
                    line.setAttribute('marker-end', 'url(#arrow)'); this.svg.appendChild(line);
                }
            });
        }
        updateStatus(txt, color) { document.getElementById('syncText').innerText = txt; document.getElementById('syncDot').style.background = color; }
    }

    window.onload = () => new StickyApp();
</script>
</body>

</html>