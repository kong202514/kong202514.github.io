 
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Sticky Notes Pro - Real-time Sync</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&family=Kanit:wght@400;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #f8fafc;
            --panel: #ffffff;
            --accent: #4f46e5;
            --text: #1e293b;
            --muted: #64748b;
            --border: #e2e8f0;
        }

        body.dark {
            --bg: #0f172a;
            --panel: #1e293b;
            --accent: #818cf8;
            --text: #f8fafc;
            --muted: #94a3b8;
            --border: #334155;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: 0.3s;
        }

        /* --- Header --- */
        header {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            z-index: 100;
            gap: 15px;
        }

        .logo {
            font-family: 'Kanit';
            font-weight: 600;
            font-size: 1.2rem;
            color: var(--accent);
        }

        .search {
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
            outline: none;
            width: 200px;
        }

        .toolbar {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }

        /* --- Buttons --- */
        .btn {
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text);
            font-size: 14px;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            border: none;
        }

        /* --- Page Tabs --- */
        .page-bar {
            background: var(--panel);
            display: flex;
            align-items: center;
            padding: 8px 20px;
            gap: 10px;
            border-top: 1px solid var(--border);
        }

        .tab {
            padding: 6px 16px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
        }

        .tab.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .tab .del-page {
            opacity: 0.5;
            font-size: 10px;
        }

        .tab .del-page:hover {
            opacity: 1;
            color: #ff4444;
        }

        /* --- Board Area --- */
        .board {
            flex: 1;
            position: relative;
            overflow: auto;
            background-image: radial-gradient(var(--muted) 0.5px, transparent 0.5px);
            background-size: 30px 30px;
        }

        /* --- Note Styling --- */
        .note {
            position: absolute;
            width: 220px;
            min-height: 130px;
            background: #fffacd;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            cursor: grab;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .note:active {
            cursor: grabbing;
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            opacity: 0.2;
            transition: 0.2s;
        }

        .note:hover .note-header {
            opacity: 1;
        }

        .content {
            flex: 1;
            outline: none;
            font-size: 14px;
            color: #334155;
            min-height: 80px;
            line-height: 1.5;
        }

        .ring-active {
            box-shadow: 0 0 0 4px var(--accent);
        }

        .color-picker {
            width: 20px;
            height: 20px;
            border: none;
            border-radius: 50%;
            padding: 0;
            cursor: pointer;
            background: none;
        }

        button.icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 2px;
        }

        footer {
            font-size: 11px;
            padding: 4px;
            text-align: center;
            color: var(--muted);
            background: var(--panel);
            border-top: 1px solid var(--border);
        }

        svg {
            pointer-events: none;
            z-index: 0;
        }
    </style>
</head>

<body>
    <header>
        <div class="logo">StickyCloud 2025</div>
        <input type="text" id="search" class="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...">
        <div class="toolbar">
            <button class="btn btn-primary" id="addNote"><span>+</span> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏ô‡πâ‡∏ï</button>
            <button class="btn" id="syncStatus">‚òÅÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö...</button>
            <button class="btn" id="toggleDark">üåô</button>
        </div>
    </header>

    <main id="board" class="board"></main>

    <div class="page-bar" id="pageBar">
        <button class="btn" id="addPage"
            style="border-radius: 50%; width: 32px; height: 32px; padding: 0; justify-content: center;">+</button>
    </div>

    <footer>‡∏¢‡πâ‡∏≤‡∏¢‡πÇ‡∏ô‡πâ‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ | ‡∏Å‡∏î üîó ‡∏ó‡∏µ‡πà‡πÇ‡∏ô‡πâ‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡πÇ‡∏ô‡πâ‡∏ï‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á</footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getFirestore, setDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyB3kPHRDHeYd6rjspNjCH11QG7T2bTd7PM",
            authDomain: "stickey-note-6bb95.firebaseapp.com",
            projectId: "stickey-note-6bb95",
            storageBucket: "stickey-note-6bb95.firebasestorage.app",
            messagingSenderId: "266704545369",
            appId: "1:266704545369:web:e403d47f324a91234a3348",
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Note Class ---
        class Note {
            constructor(parent, data) {
                this.parent = parent;
                this.id = data.id || "n_" + Date.now() + Math.floor(Math.random() * 1000);
                this.text = data.text || '';
                this.color = data.color || '#fffacd';
                this.x = data.x || 100;
                this.y = data.y || 100;
                this.createEl();
            }

            createEl() {
                this.el = document.createElement('div');
                this.el.className = 'note';
                this.el.style.backgroundColor = this.color;
                this.el.style.left = this.x + 'px';
                this.el.style.top = this.y + 'px';
                this.el.dataset.id = this.id;

                this.el.innerHTML = `
                    <div class="note-header">
                        <button class="icon-btn connect-btn" title="‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á">üîó</button>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input type="color" class="color-picker" value="${this.color}">
                            <button class="icon-btn delete-btn">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="content" contenteditable="true">${this.text}</div>
                `;

                this.el.querySelector('.delete-btn').onclick = () => this.parent.deleteNote(this.id);
                this.el.querySelector('.color-picker').oninput = (e) => {
                    this.color = e.target.value;
                    this.el.style.backgroundColor = this.color;
                    this.parent.autoSave();
                };
                this.el.querySelector('.connect-btn').onclick = () => this.parent.connectionManager.startConnection(this);
                this.el.querySelector('.content').oninput = () => {
                    this.text = this.el.querySelector('.content').innerText;
                    this.parent.autoSave();
                };

                this.makeDraggable();
            }

            makeDraggable() {
                let ox, oy, dragging = false;
                this.el.onmousedown = (e) => {
                    if (e.target.closest('button, input, .content')) return;
                    dragging = true;
                    ox = e.clientX - this.el.offsetLeft;
                    oy = e.clientY - this.el.offsetTop;
                    this.el.style.zIndex = 1000;
                };
                document.addEventListener('mousemove', (e) => {
                    if (!dragging) return;
                    this.x = e.clientX - ox;
                    this.y = e.clientY - oy;
                    this.el.style.left = this.x + 'px';
                    this.el.style.top = this.y + 'px';
                    this.parent.connectionManager.drawLines();
                });
                document.addEventListener('mouseup', () => {
                    if (dragging) {
                        dragging = false;
                        this.el.style.zIndex = '';
                        this.parent.autoSave();
                    }
                });
            }

            getCenter() {
                return { x: this.x + this.el.offsetWidth / 2, y: this.y + this.el.offsetHeight / 2 };
            }
        }

        // --- Connection Manager ---
        class ConnectionManager {
            constructor(parent) {
                this.parent = parent;
                this.conns = [];
                this.pending = null;
                this.initSVG();
            }

            initSVG() {
                this.svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                Object.assign(this.svg.style, { position: 'absolute', top: 0, left: 0, width: '100%', height: '100%' });
                this.svg.innerHTML = `
                    <defs>
                        <marker id="head" markerWidth="10" markerHeight="7" refX="20" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8" />
                        </marker>
                    </defs>`;
                this.parent.container.prepend(this.svg);
            }

            startConnection(note) {
                if (!this.pending) {
                    this.pending = note;
                    note.el.classList.add('ring-active');
                } else {
                    if (this.pending.id !== note.id) {
                        this.conns.push({ from: this.pending.id, to: note.id });
                        this.drawLines();
                        this.parent.autoSave();
                    }
                    this.pending.el.classList.remove('ring-active');
                    this.pending = null;
                }
            }

            drawLines() {
                const oldLines = this.svg.querySelectorAll('line');
                oldLines.forEach(l => l.remove());

                this.conns.forEach(c => {
                    const n1 = this.parent.notes.find(n => n.id === c.from);
                    const n2 = this.parent.notes.find(n => n.id === c.to);
                    if (n1 && n2) {
                        const p1 = n1.getCenter();
                        const p2 = n2.getCenter();
                        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                        line.setAttribute('x1', p1.x); line.setAttribute('y1', p1.y);
                        line.setAttribute('x2', p2.x); line.setAttribute('y2', p2.y);
                        line.setAttribute('stroke', '#94a3b8');
                        line.setAttribute('stroke-width', '2');
                        line.setAttribute('marker-end', 'url(#head)');
                        this.svg.appendChild(line);
                    }
                });
            }

            clear() { this.conns = []; this.drawLines(); }
        }

        // --- Main App Controller ---
        class StickyApp {
            constructor() {
                this.notes = [];
                this.pages = JSON.parse(localStorage.getItem('notes_pages')) || [{ id: 'main', name: '‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å' }];
                this.activePageId = localStorage.getItem('notes_active_page') || 'main';
                this.container = document.getElementById('board');
                this.syncEl = document.getElementById('syncStatus');

                this.connectionManager = new ConnectionManager(this);
                this.isRemoteUpdate = false;
                this.saveTimeout = null;
                this.unsubscribe = null;

                this.init();
            }

            init() {
                document.getElementById('addNote').onclick = () => this.addNote();
                document.getElementById('addPage').onclick = () => this.createPage();
                document.getElementById('toggleDark').onclick = () => {
                    document.body.classList.toggle('dark');
                    localStorage.theme = document.body.classList.contains('dark') ? 'dark' : 'light';
                };
                document.getElementById('search').oninput = (e) => this.filter(e.target.value);

                if (localStorage.theme === 'dark') document.body.classList.add('dark');

                this.renderTabs();
                this.startRealtimeSync();
            }

            // Real-time Sync Logic
            startRealtimeSync() {
                if (this.unsubscribe) this.unsubscribe();
                this.syncEl.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå...";

                this.unsubscribe = onSnapshot(doc(db, "stickynotes", this.activePageId), (snap) => {
                    if (snap.exists()) {
                        const data = snap.data();
                        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ Render ‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
                        const currentDataStr = JSON.stringify(this.notes.map(n => n.id).sort());
                        const remoteDataStr = JSON.stringify((data.notes || []).map(n => n.id).sort());

                        if (currentDataStr !== remoteDataStr || !this.isSaving) {
                            this.renderPage(data);
                        }
                    } else {
                        this.renderPage({ notes: [], conns: [] });
                    }
                    this.syncEl.innerText = "‚úÖ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå";
                });
            }

            autoSave() {
                this.isSaving = true;
                this.syncEl.innerText = "‚è≥ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...";
                clearTimeout(this.saveTimeout);

                this.saveTimeout = setTimeout(async () => {
                    const data = {
                        notes: this.notes.map(n => ({ id: n.id, text: n.text, color: n.color, x: n.x, y: n.y })),
                        conns: this.connectionManager.conns,
                        updatedAt: Date.now()
                    };

                    localStorage.setItem(`local_page_${this.activePageId}`, JSON.stringify(data));
                    try {
                        await setDoc(doc(db, "stickynotes", this.activePageId), data);
                        this.syncEl.innerText = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß";
                    } catch (e) {
                        this.syncEl.innerText = "‚ùå ‡πÄ‡∏ã‡∏ü‡∏û‡∏•‡∏≤‡∏î";
                    } finally {
                        this.isSaving = false;
                    }
                }, 1000); // Debounce 1 second
            }

            renderPage(data) {
                this.notes.forEach(n => n.el.remove());
                this.notes = [];
                this.connectionManager.clear();

                if (data.notes) {
                    data.notes.forEach(d => {
                        const n = new Note(this, d);
                        this.notes.push(n);
                        this.container.appendChild(n.el);
                    });
                }
                if (data.conns) {
                    this.connectionManager.conns = data.conns;
                    this.connectionManager.drawLines();
                }
            }

            // Page Management
            renderTabs() {
                const bar = document.getElementById('pageBar');
                bar.querySelectorAll('.tab').forEach(t => t.remove());

                this.pages.forEach(p => {
                    const tab = document.createElement('div');
                    tab.className = `tab ${p.id === this.activePageId ? 'active' : ''}`;
                    tab.innerHTML = `<span>${p.name}</span> <span class="del-page">‚úï</span>`;
                    tab.onclick = () => this.switchPage(p.id);
                    tab.querySelector('.del-page').onclick = (e) => {
                        e.stopPropagation();
                        this.deletePage(p.id);
                    };
                    bar.insertBefore(tab, document.getElementById('addPage'));
                });
            }

            createPage() {
                const name = prompt("‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà:");
                if (!name) return;
                const id = "p_" + Date.now();
                this.pages.push({ id, name });
                localStorage.setItem('notes_pages', JSON.stringify(this.pages));
                this.switchPage(id);
            }

            switchPage(id) {
                this.activePageId = id;
                localStorage.setItem('notes_active_page', id);
                this.renderTabs();
                this.startRealtimeSync();
            }

            deletePage(id) {
                if (this.pages.length === 1) return;
                if (!confirm("‡∏•‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡∏ñ‡∏≤‡∏ß‡∏£?")) return;
                this.pages = this.pages.filter(p => p.id !== id);
                localStorage.setItem('notes_pages', JSON.stringify(this.pages));
                if (this.activePageId === id) this.activePageId = this.pages[0].id;
                this.switchPage(this.activePageId);
            }

            // Note Actions
            addNote() {
                const n = new Note(this, { x: 100 + Math.random() * 100, y: 100 + Math.random() * 100 });
                this.notes.push(n);
                this.container.appendChild(n.el);
                this.autoSave();
            }

            deleteNote(id) {
                this.notes = this.notes.filter(n => n.id !== id);
                this.container.querySelector(`[data-id="${id}"]`)?.remove();
                this.connectionManager.conns = this.connectionManager.conns.filter(c => c.from !== id && c.to !== id);
                this.connectionManager.drawLines();
                this.autoSave();
            }

            filter(term) {
                const t = term.toLowerCase();
                this.notes.forEach(n => {
                    n.el.style.display = n.text.toLowerCase().includes(t) ? '' : 'none';
                });
            }
        }

        // Run App
        window.addEventListener('DOMContentLoaded', () => {
            new StickyApp();
        });
    </script>
</body>

</html>