 !DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets CRUD with Search & Upload</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f0f2f5;
            padding: 40px 20px;
            font-family: 'Sarabun', sans-serif;
        }

        .container {
            max-width: 1100px;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }

        .img-preview {
            width: 45px;
            height: 45px;
            object-fit: cover;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .loading {
            display: none;
            margin-left: 10px;
            font-weight: bold;
        }

        .avatar-placeholder {
            width: 45px;
            height: 45px;
            background: #6c757d;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
        }

        .table thead {
            background-color: #495057;
            color: white;
        }
    </style>
</head>

<body>

    <div class="container">
        <h2 class="text-center mb-4">üöÄ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</h2>

        <div class="row g-2 mb-4 p-4 bg-light rounded border shadow-sm">
            <div class="col-md-3"><input type="text" id="name" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"></div>
            <div class="col-md-3"><input type="email" id="email" class="form-control" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•"></div>
            <div class="col-md-4"><input type="file" id="fileInput" class="form-control" accept="image/*"></div>
            <div class="col-md-2"><button onclick="submitForm()" id="btnAdd"
                    class="btn btn-primary w-100">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button></div>
            <div id="loader" class="text-primary mt-2 small loading">‚öôÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£... ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</div>
        </div>

        <div class="mb-3">
            <input type="text" id="searchInput" class="form-control" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏µ‡πÄ‡∏°‡∏•..."
                onkeyup="filterTable()">
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle" id="mainTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th>
                        <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                        <th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                        <th class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <tr>
                        <td colspan="5" class="text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-id">
                    <div class="mb-3 text-center" id="edit-img-container"></div>
                    <div class="mb-3">
                        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠:</label>
                        <input type="text" id="edit-name" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</label>
                        <input type="email" id="edit-email" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):</label>
                        <input type="file" id="edit-fileInput" class="form-control" accept="image/*">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" id="btnUpdate" class="btn btn-success"
                        onclick="updateData()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // *** ‡∏ß‡∏≤‡∏á URL ‡∏Ç‡∏≠‡∏á Web App ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì Deploy ‡∏à‡∏≤‡∏Å Apps Script ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ***
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwDCu09iEjAU2f2NUPxitN_-G4uNW4dtbkmlF6QVEdNXOJoLUbIIpHe1SYE_H3l7UP4/exec";
        let editModal;

        document.addEventListener("DOMContentLoaded", () => {
            editModal = new bootstrap.Modal(document.getElementById('editModal'));
            loadData();
        });

        function loadData() {
            fetch(WEB_APP_URL)
                .then(res => res.json())
                .then(data => {
                    let html = "";
                    data.forEach(row => {
                        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ row[3] ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠ "undefined"
                        const hasImg = row[3] && row[3] !== "" && row[3] !== "undefined";
                        const imgTag = hasImg
                            ? `<img src="${row[3]}" class="img-preview" onerror="this.src='https://via.placeholder.com/50'">`
                            : `<div class="avatar-placeholder">${row[1] ? row[1].charAt(0).toUpperCase() : '?'}</div>`;

                        html += `<tr>
                            <td><small class="text-muted">${row[0]}</small></td>
                            <td>${imgTag}</td>
                            <td>${row[1]}</td>
                            <td>${row[2]}</td>
                            <td class="text-center">
                                <button class="btn btn-outline-warning btn-sm" onclick="openEditModal('${row[0]}','${row[1]}','${row[2]}','${row[3]}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteData('${row[0]}')">‡∏•‡∏ö</button>
                            </td>
                        </tr>`;
                    });
                    document.getElementById("table-body").innerHTML = html || '<tr><td colspan="5" class="text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
                });
        }

        async function sendPost(params) {
            document.getElementById('loader').style.display = 'block';
            document.getElementById('btnAdd').disabled = true;

            const formData = new URLSearchParams();
            for (const key in params) { formData.append(key, params[key]); }

            try {
                // ‡πÉ‡∏ä‡πâ fetch ‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥ (Google Apps Script ‡∏à‡∏∞‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö 200 ‡∏ñ‡∏∂‡∏á‡πÅ‡∏°‡πâ‡∏à‡∏∞‡∏ï‡∏¥‡∏î CORS ‡πÉ‡∏ô‡∏ö‡∏≤‡∏á‡∏Å‡∏£‡∏ì‡∏µ)
                await fetch(WEB_APP_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: formData.toString()
                });

                // ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Script ‡∏ù‡∏±‡πà‡∏á Google ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à
                setTimeout(() => {
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('btnAdd').disabled = false;
                    loadData();
                }, 2000);
            } catch (e) {
                console.error(e);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
                document.getElementById('loader').style.display = 'none';
                document.getElementById('btnAdd').disabled = false;
            }
        }

        function submitForm() {
            const name = document.getElementById("name").value;
            const email = document.getElementById("email").value;
            const fileInput = document.getElementById("fileInput");
            if (!name || !email) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

            let payload = { action: "add", name: name, email: email };
            if (fileInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    payload.fileData = e.target.result.split(",")[1];
                    payload.fileType = fileInput.files[0].type;
                    sendPost(payload);
                    clearForm();
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                sendPost(payload);
                clearForm();
            }
        }

        function clearForm() {
            document.getElementById("name").value = "";
            document.getElementById("email").value = "";
            document.getElementById("fileInput").value = "";
        }

        function openEditModal(id, name, email, img) {
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-name').value = name;
            document.getElementById('edit-email').value = email;
            const imgDisplay = (img && img !== "undefined") ? `<img src="${img}" class="img-preview mb-2" style="width:80px; height:80px;">` : "";
            document.getElementById('edit-img-container').innerHTML = imgDisplay;
            editModal.show();
        }

        function updateData() {
            const id = document.getElementById('edit-id').value;
            const name = document.getElementById('edit-name').value;
            const email = document.getElementById('edit-email').value;
            const fileInput = document.getElementById('edit-fileInput');

            let payload = { action: "update", id, name, email };
            if (fileInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    payload.fileData = e.target.result.split(",")[1];
                    payload.fileType = fileInput.files[0].type;
                    sendPost(payload);
                    fileInput.value = "";
                    editModal.hide();
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                sendPost(payload);
                editModal.hide();
            }
        }

        function deleteData(id) {
            if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?")) return;
            sendPost({ action: "delete", id: id });
        }

        function filterTable() {
            const input = document.getElementById("searchInput").value.toUpperCase();
            const tr = document.getElementById("table-body").getElementsByTagName("tr");
            for (let i = 0; i < tr.length; i++) {
                const tdName = tr[i].getElementsByTagName("td")[2];
                const tdEmail = tr[i].getElementsByTagName("td")[3];
                if (tdName || tdEmail) {
                    const txtValue = (tdName.textContent || tdName.innerText) + (tdEmail.textContent || tdEmail.innerText);
                    tr[i].style.display = txtValue.toUpperCase().indexOf(input) > -1 ? "" : "none";
                }
            }
        }
    </script>
</body>

</html>