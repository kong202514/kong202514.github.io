 
<html lang="th">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Sticky Notes ‚Äî Arrow Connections</title>

    <link
        href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&family=Kanit:wght@300;400;600&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg: #f8fafc;
            --panel: #e25353;
            --accent: #6b6bf0;
            --text: #111;
            --muted: #666;
            --arrow-color: #94a3b8;
        }

        body.dark {
            --bg: #1e293b;
            --panel: #334155;
            --accent: #7cc9ff;
            --text: #f8fafc;
            --muted: #94a3b8;
            --arrow-color: #64748b;
        }

        body {
            font-family: 'Sarabun', 'Kanit', system-ui;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            transition: background 0.3s;
        }

        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            background: var(--panel);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        header .title {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--accent);
        }

        .toolbar {
            margin-left: auto;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            background: var(--panel);
            border: 1px solid rgba(0, 0, 0, 0.1);
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--accent);
            color: white;
        }

        .search {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            background: var(--panel);
            color: var(--text);
            width: 200px;
        }

        .board {
            position: relative;
            flex: 1;
            overflow: auto;
            background-image: radial-gradient(var(--muted) 0.5px, transparent 0.5px);
            background-size: 30px 30px;
            background-color: var(--bg);
        }

        .note {
            position: absolute;
            width: 200px;
            min-height: 120px;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: flex;
            background-color: #7cc9ff;
            flex-direction: column;
            cursor: grab;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            opacity: 0.6;
        }

        .note:hover .note-header {
            opacity: 1;
        }

        .content {
            flex: 1;
            outline: none;
            font-size: 14px;
            color: #1e293b;
        }

        .delete,
        .connect {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        .color-picker {
            width: 20px;
            height: 20px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            padding: 0;
        }

        footer {
            padding: 8px;
            font-size: 12px;
            text-align: center;
            background: var(--panel);
            color: var(--muted);
        }

        .ring-active {
            outline: 3px solid var(--accent);
        }
    </style>
</head>

<body>
    <div class="app">
        <header>
            <div class="title">Sticky Notes OOP</div>
            <input id="search" class="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏ô‡πâ‡∏ï..." />
            <div class="toolbar">
                <button class="btn" id="addNote"><span>+</span> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏ô‡πâ‡∏ï</button>
                <button class="btn" id="cloudSyncBtn">‚òÅÔ∏è Sync Cloud</button>
                <button class="btn" id="toggleDark">üåô Dark</button>
            </div>
        </header>

        <main id="board" class="board"></main>

        <footer>‡∏•‡∏≤‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏î‡πâ | ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ | ‡∏Å‡∏î üîó ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏´‡∏±‡∏ß‡∏•‡∏π‡∏Å‡∏®‡∏£</footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getFirestore, setDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB3kPHRDHeYd6rjspNjCH11QG7T2bTd7PM",
            authDomain: "stickey-note-6bb95.firebaseapp.com",
            projectId: "stickey-note-6bb95",
            storageBucket: "stickey-note-6bb95.firebasestorage.app",
            messagingSenderId: "266704545369",
            appId: "1:266704545369:web:e403d47f324a91234a3348",
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Note Class ---
        class Note {
            constructor(app, data) {
                this.app = app;
                this.id = data.id || Date.now();
                this.text = data.text || '';
                this.color = data.color || '#fffacd';
                this.x = data.x || 50;
                this.y = data.y || 50;
                this.createElement();
            }

            createElement() {
                this.el = document.createElement('div');
                this.el.className = 'note';
                this.el.style.backgroundColor = this.color;
                this.el.style.left = this.x + 'px';
                this.el.style.top = this.y + 'px';
                this.el.dataset.id = this.id;

                this.el.innerHTML = `
                    <div class="note-header">
                        <button class="connect">üîó</button>
                        <div>
                            <input type="color" class="color-picker" value="${this.color}">
                            <button class="delete">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="content" contenteditable="true">${this.text}</div>
                `;

                this.el.querySelector('.delete').onclick = () => this.app.deleteNote(this.id);
                this.el.querySelector('.color-picker').oninput = (e) => {
                    this.color = e.target.value;
                    this.el.style.backgroundColor = this.color;
                    this.app.saveAll();
                };
                this.el.querySelector('.connect').onclick = () => this.app.connectionManager.startConnection(this);
                this.el.querySelector('.content').onblur = () => {
                    this.text = this.el.querySelector('.content').innerText;
                    this.app.saveAll();
                };

                this.enableDrag();
            }

            enableDrag() {
                let ox, oy, dragging = false;
                this.el.addEventListener('mousedown', (e) => {
                    if (e.target.closest('input, button, .content')) return;
                    dragging = true;
                    ox = e.clientX - this.el.offsetLeft;
                    oy = e.clientY - this.el.offsetTop;
                    this.el.style.zIndex = 1000;
                });
                document.addEventListener('mousemove', (e) => {
                    if (!dragging) return;
                    this.x = e.clientX - ox;
                    this.y = e.clientY - oy;
                    this.el.style.left = this.x + 'px';
                    this.el.style.top = this.y + 'px';
                    this.app.connectionManager.updateLines(this.id);
                });
                document.addEventListener('mouseup', () => {
                    if (dragging) {
                        dragging = false;
                        this.el.style.zIndex = '';
                        this.app.saveAll();
                    }
                });
            }

            getCenter() {
                return { x: this.x + this.el.offsetWidth / 2, y: this.y + this.el.offsetHeight / 2 };
            }
        }

        // --- Connection Manager (With Arrows) ---
        class ConnectionManager {
            constructor(app) {
                this.app = app;
                this.connections = [];
                this.pendingStart = null;
                this.initSVG();
            }

            initSVG() {
                this.svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                Object.assign(this.svg.style, {
                    position: 'absolute', top: 0, left: 0, width: '100%', height: '100%', pointerEvents: 'none'
                });

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á Marker ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏•‡∏π‡∏Å‡∏®‡∏£
                const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
                const marker = document.createElementNS("http://www.w3.org/2000/svg", "marker");
                marker.setAttribute("id", "arrowhead");
                marker.setAttribute("markerWidth", "10");
                marker.setAttribute("markerHeight", "7");
                marker.setAttribute("refX", "22"); // ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏û‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÇ‡∏ô‡πâ‡∏ï‡∏û‡∏≠‡∏î‡∏µ
                marker.setAttribute("refY", "3.5");
                marker.setAttribute("orient", "auto");

                const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                polygon.setAttribute("points", "0 0, 10 3.5, 0 7");
                polygon.setAttribute("fill", "gray");

                marker.appendChild(polygon);
                defs.appendChild(marker);
                this.svg.appendChild(defs);
                this.app.container.prepend(this.svg);
            }

            startConnection(note) {
                if (!this.pendingStart) {
                    this.pendingStart = note;
                    note.el.classList.add('ring-active');
                } else {
                    if (this.pendingStart.id !== note.id) {
                        this.addConnection(this.pendingStart.id, note.id);
                    }
                    this.pendingStart.el.classList.remove('ring-active');
                    this.pendingStart = null;
                }
            }

            addConnection(fromId, toId) {
                const line = this.createLineElement();
                this.connections.push({ from: fromId, to: toId, line });
                this.updateLinePosition(fromId, toId, line);
                this.app.saveAll();
            }

            createLineElement() {
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute('stroke', 'gray');
                line.setAttribute('stroke-width', '6');
                line.setAttribute('marker-end', 'url(#arrowhead)'); // ‡πÉ‡∏™‡πà‡∏´‡∏±‡∏ß‡∏•‡∏π‡∏Å‡∏®‡∏£
                this.svg.appendChild(line);
                return line;
            }

            updateLinePosition(fromId, toId, line) {
                const from = this.app.getNoteById(fromId);
                const to = this.app.getNoteById(toId);
                if (from && to) {
                    const A = from.getCenter();
                    const B = to.getCenter();
                    line.setAttribute('x1', A.x); line.setAttribute('y1', A.y);
                    line.setAttribute('x2', B.x); line.setAttribute('y2', B.y);
                }
            }

            updateLines(noteId) {
                this.connections.forEach(c => {
                    if (c.from === noteId || c.to === noteId) this.updateLinePosition(c.from, c.to, c.line);
                });
            }

            renderExisting(data) {
                this.connections.forEach(c => c.line?.remove());
                this.connections = data.map(c => {
                    const line = this.createLineElement();
                    this.updateLinePosition(c.from, c.to, line);
                    return { ...c, line };
                });
            }
        }

        // --- Main App Class ---
        class StickyApp {
            constructor() {
                this.notes = [];
                this.container = document.getElementById('board');
                this.connectionManager = new ConnectionManager(this);
                this.addBtn = document.getElementById('addNote');
                this.syncBtn = document.getElementById('cloudSyncBtn');
                this.init();
            }

            init() {
                this.loadLocal();
                this.addBtn.onclick = () => this.addNote();
                this.syncBtn.onclick = () => this.syncWithCloud();
                document.getElementById('search').oninput = (e) => {
                    const term = e.target.value.toLowerCase();
                    this.notes.forEach(n => n.el.style.display = n.text.toLowerCase().includes(term) ? '' : 'none');
                };
            }

            addNote() {
                const note = new Note(this, { x: 100 + Math.random() * 50, y: 100 + Math.random() * 50 });
                this.notes.push(note);
                this.container.appendChild(note.el);
                this.saveAll();
            }

            getNoteById(id) { return this.notes.find(n => n.id == id); }

            deleteNote(id) {
                this.notes = this.notes.filter(n => n.id !== id);
                this.container.querySelector(`.note[data-id="${id}"]`)?.remove();
                this.connectionManager.connections = this.connectionManager.connections.filter(c => {
                    if (c.from === id || c.to === id) { c.line.remove(); return false; }
                    return true;
                });
                this.saveAll();
            }

            renderUI(data) {
                this.container.querySelectorAll('.note').forEach(n => n.remove());
                this.notes = (data.notes || []).map(nData => {
                    const note = new Note(this, nData);
                    this.container.appendChild(note.el);
                    return note;
                });
                this.connectionManager.renderExisting(data.connections || []);
            }

            async saveAll() {
                const data = {
                    notes: this.notes.map(n => ({ id: n.id, text: n.text, color: n.color, x: n.x, y: n.y })),
                    connections: this.connectionManager.connections.map(c => ({ from: c.from, to: c.to }))
                };
                localStorage.setItem('notesData', JSON.stringify(data));
                try { await setDoc(doc(db, "stickynotes", "default"), data); } catch (e) { console.error(e); }
            }

            loadLocal() {
                const data = JSON.parse(localStorage.getItem('notesData') || '{}');
                if (data.notes) this.renderUI(data);
            }

            async syncWithCloud() {
                this.syncBtn.innerText = "‚è≥ Syncing...";
                try {
                    const snap = await getDoc(doc(db, "stickynotes", "default"));
                    if (snap.exists()) {
                        this.renderUI(snap.data());
                        localStorage.setItem('notesData', JSON.stringify(snap.data()));
                    }
                } catch (e) { console.error(e); }
                this.syncBtn.innerText = "‚òÅÔ∏è Sync Cloud";
            }
        }

        new StickyApp();

        const toggleDark = document.getElementById('toggleDark');
        if (localStorage.theme === 'dark') document.body.classList.add('dark');
        toggleDark.onclick = () => {
            document.body.classList.toggle('dark');
            localStorage.theme = document.body.classList.contains('dark') ? 'dark' : 'light';
        };
    </script>
</body>

</html>